<!DOCTYPE html>
<html>
<head>
<title>VizDoc</title>
</head>
<link rel="stylesheet" type="text/css" href="css/vis.min.css" />

<style type="text/css">
  #animation {
    width: 600px;
    height: 700px;
    margin: 0 auto;
  }

  body {
    text-align: center;
  }

</style>

<body>
  <h2>VizDoc</h2>
  <div id="animation">
  </div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="js/vis.min.js"></script>
<script type="text/javascript">
  window.karma = [];
  $(document).ready(function(){
    var data = [{
     'id' : 0,
     'class_name' : 'OrderController',
     'method_name' : 'Index',
     'params': '{order_id: 5}',
     'calls' : [
       {
         'id' : 1,
         'class_name' : 'User',
         'method_name' : 'Find',
         'params' : '{user_id : 10}',
         'calls' : [],
         'return_value' : 'user_data'
       },
       {
         'id' : 2,
         'class_name' : 'Order',
         'method_name' : 'Find',
         'params' : '{order_id : 5}',
         'calls' : [
           {
             'id' : 3,
             'class_name' : 'Restaurant',
             'method_name' : 'Find',
             'params' : '{restaurant_id : 100}',
             'calls' : [],
             'return_value' : 'restaurant_data'
           }
         ],
         'return_value' : 'order_data'
       }
     ],
     'return_value' : 'order json'
    }];

    var animation = init_animation();
    window.animation = animation;
    animation.nodes.add({id:'root', label: 'Start'});
    simulate_animation(animation, 'root', data, null);
  });



  simulate_animation = function(animation, root_id, data){
    if(data.length == 0){
      //process karma
      last_karma = karma.pop();
      if(last_karma == null) return;
      animation.edges.add({to: last_karma.parent_id, from: last_karma.node_id, label: last_karma.return_value});
      animation.network.selectNodes([last_karma.parent_id]);
      simulate_animation(animation, last_karma.parent_id, last_karma.siblings);
    }
    else {
      node = data.splice(0, 1);
      node = node[0];
      animation.nodes.add({id: node.id, label: [node.class_name, node.method_name].join("::")});
      animation.edges.add({to: node.id, from: root_id, label: node.params});
      animation.network.selectNodes([node.id]);

      setTimeout(function(){
        karma.push({
          parent_id: root_id,
          node_id: node.id,
          return_value: node.return_value,
          siblings: data
        });
        simulate_animation(animation, node.id, node.calls);
      }, 1000);
    }
  };

  init_animation = function(){
    nodes = new vis.DataSet();
    edges = new vis.DataSet();

    // create a network
    var container = document.getElementById('animation');
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {
      autoResize: true,
      layout: {
        hierarchical: {
          enabled: true,
          levelSeparation: 150,
          direction: 'UD',   // UD, DU, LR, RL
          sortMethod: 'directed'
        }
      },
      edges: {
        //physics: false,
        arrows: 'to',
        smooth: {
          enabled: true,
          type: 'curvedCW',
          roundness: 0.3
        }
      },
      interaction: {
        dragNodes: false
      },
      nodes: {
        shape: 'box',
        color: {
          highlight: "#ccc"
        }
      }
    };
    data.network = new vis.Network(container, data, options);
    return data;
  }



</script>
</html>
